<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Django基础 | Python | 全栈开发</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo-1.png">
    <meta name="description" content="Python 中的 Java搬砖工">
    
    <link rel="preload" href="/assets/css/0.styles.59eae97f.css" as="style"><link rel="preload" href="/assets/js/app.3924b14b.js" as="script"><link rel="preload" href="/assets/js/3.8a978e8e.js" as="script"><link rel="preload" href="/assets/js/4.d4a9f15a.js" as="script"><link rel="preload" href="/assets/js/11.e4da742c.js" as="script"><link rel="preload" href="/assets/js/10.af37d65e.js" as="script"><link rel="prefetch" href="/assets/js/12.f27be98b.js"><link rel="prefetch" href="/assets/js/13.9222f50b.js"><link rel="prefetch" href="/assets/js/14.e9b3d9f0.js"><link rel="prefetch" href="/assets/js/15.baf8c0e6.js"><link rel="prefetch" href="/assets/js/16.84588abc.js"><link rel="prefetch" href="/assets/js/17.27d320f0.js"><link rel="prefetch" href="/assets/js/18.99a5c396.js"><link rel="prefetch" href="/assets/js/19.8be2b187.js"><link rel="prefetch" href="/assets/js/20.115197ea.js"><link rel="prefetch" href="/assets/js/21.2c3dd6d1.js"><link rel="prefetch" href="/assets/js/22.41c825b2.js"><link rel="prefetch" href="/assets/js/23.f1c94ada.js"><link rel="prefetch" href="/assets/js/24.5525b1de.js"><link rel="prefetch" href="/assets/js/25.b8fb0305.js"><link rel="prefetch" href="/assets/js/26.a26bfbb8.js"><link rel="prefetch" href="/assets/js/27.729162ac.js"><link rel="prefetch" href="/assets/js/28.a40fff9b.js"><link rel="prefetch" href="/assets/js/29.894dd070.js"><link rel="prefetch" href="/assets/js/30.0a627b8a.js"><link rel="prefetch" href="/assets/js/31.7d0d7b43.js"><link rel="prefetch" href="/assets/js/5.6b6432fa.js"><link rel="prefetch" href="/assets/js/6.bbd125e3.js"><link rel="prefetch" href="/assets/js/7.85592ef4.js"><link rel="prefetch" href="/assets/js/8.0d6e8d15.js"><link rel="prefetch" href="/assets/js/9.c2e68dae.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.9e060fc2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59eae97f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo-1.png" alt="Python | 全栈开发" class="logo"> <span class="site-name can-hide">Python | 全栈开发</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/hou-duan/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/qian-duan/" class="nav-link">
  前端
</a></div> <a href="https://github.com/small-universe/vuepress-python-full-stack" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/hou-duan/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/qian-duan/" class="nav-link">
  前端
</a></div> <a href="https://github.com/small-universe/vuepress-python-full-stack" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Django</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/hou-duan/django/djangoji-chu.html" aria-current="page" class="active sidebar-link">Django基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#一、python-web-框架要点" class="sidebar-link">一、Python Web 框架要点</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#二、django介绍" class="sidebar-link">二、Django介绍</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#三、工程搭建" class="sidebar-link">三、工程搭建</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#四、配置" class="sidebar-link">四、配置</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#五、请求与响应" class="sidebar-link">五、请求与响应</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#六、类视图与中间件" class="sidebar-link">六、类视图与中间件</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#七、模板-了解" class="sidebar-link">七、模板（了解）</a></li><li class="sidebar-sub-header"><a href="/hou-duan/django/djangoji-chu.html#八、数据库" class="sidebar-link">八、数据库</a></li></ul></li><li><a href="/hou-duan/django/drf.html" class="sidebar-link">Django  REST  framework</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Jenkins</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="django基础">Django基础</h1> <p>Django学习资料:</p> <ul><li><p><a href="https://www.djangoproject.com/" target="_blank" rel="noopener noreferrer">官方网站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://github.com/django/django" target="_blank" rel="noopener noreferrer">Github源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://docs.djangoproject.com/en/2.2/" target="_blank" rel="noopener noreferrer">2.2版英文文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://docs.djangoproject.com/zh-hans/2.2/" target="_blank" rel="noopener noreferrer">2.2版中文文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="http://djangobook.com/" target="_blank" rel="noopener noreferrer">Django Book 教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="http://www.tangowithdjango.com/book17/" target="_blank" rel="noopener noreferrer">Tange With Django 教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <h2 id="一、python-web-框架要点">一、Python Web 框架要点</h2> <h3 id="_01-web应用程序处理流程">01 | Web应用程序处理流程</h3> <p><img src="/assets/img/image-20210921121704299.eae68a97.png" alt="image-20210921121704299"></p> <h3 id="_02-web程序框架的意义">02 | Web程序框架的意义</h3> <ul><li>用于搭建Web应用程序</li> <li>免去不同Web应用相同代码部分的重复编写，只需关心Web应用核心的业务逻辑实现</li></ul> <h3 id="_03-web应用程序的本质">03 | Web应用程序的本质</h3> <ul><li>接收并解析HTTP请求，获取具体的请求信息</li> <li>处理本次HTTP请求，即完成本次请求的业务逻辑处理</li> <li>构造并返回处理结果——HTTP响应</li></ul> <h3 id="_04-web框架学习方法">04 | Web框架学习方法</h3> <ul><li>如何搭建工程程序
<ul><li>工程的组建</li> <li>工程的配置</li> <li>路由定义</li> <li>视图函数定义</li></ul></li> <li>如何获取请求数据（操作request对象）</li> <li>如何构造响应数据（构造response对象）</li> <li>如何使用中间层</li> <li>框架提供的其他功能组件的使用
<ul><li>数据库</li> <li>模板</li> <li>admin</li></ul></li></ul> <h2 id="二、django介绍">二、Django介绍</h2> <p><img src="/assets/img/image-20210921122046800.3f62c4c5.png" alt="image-20210921122046800"></p> <h3 id="_01-简介">01 | 简介</h3> <p>Django，<strong>发音为[`dʒæŋɡəʊ]</strong>，是用python语言写的开源web开发框架，并遵循MVC设计。劳伦斯出版集团为了开发以新闻内容为主的网站，而开发出来了这个框架，于2005年7月在BSD许可证下发布。这个名称来源于比利时的爵士音乐家DjangoReinhardt，他是一个吉普赛人，主要以演奏吉它为主，还演奏过小提琴等。<strong>由于Django在近年来的迅速发展，应用越来越广泛，被著名IT开发杂志SDTimes评选为2013SDTimes100，位列&quot;API、库和框架&quot;分类第6位，被认为是该领域的佼佼者。</strong></p> <p><img src="/assets/img/image-20210921122319971.a58863bf.png" alt="image-20210921122319971"></p> <p>Django的<strong>主要目的是简便、快速的开发数据库驱动的网站</strong>。它强调代码复用，多个组件可以很方便的以&quot;插件&quot;形式服务于整个框架，Django有许多功能强大的第三方插件，你甚至可以很方便的开发出自己的工具包。这使得Django具有很强的可扩展性。它还强调快速开发和DRY(DoNotRepeatYourself)原则。</p> <h3 id="_2-特点">2 | 特点</h3> <h4 id="重量级框架">重量级框架</h4> <p>对比Flask框架，Django原生提供了众多的功能组件，让开发更简便快速。</p> <ul><li><p>提供项目工程管理的自动化脚本工具</p></li> <li><p>数据库ORM支持（对象关系映射，英语：Object Relational Mapping）</p></li> <li><p>模板</p></li> <li><p>表单</p></li> <li><p>Admin管理站点</p></li> <li><p>文件管理</p></li> <li><p>认证权限</p></li> <li><p>session机制</p></li> <li><p>缓存</p></li></ul> <h4 id="mvt模式">MVT模式</h4> <p>有一种程序设计模式叫<strong>MVC</strong>，其核心思想是<strong>分工、解耦，让不同的代码块之间降低耦合，增强代码的可扩展性和可移植性，实现向后兼容</strong>。</p> <div class="custom-block tip"><p class="custom-block-title">Tips</p> <p>MVC的全拼为<strong>Model-View-Controller</strong>，最早由TrygveReenskaug在1978年提出，是施乐帕罗奥多研究中心(Xerox PARC)在20世纪80年代为程序语言Smalltalk发明的一种软件设计模式，是为了将传统的输入（input）、处理（processing）、输出（output）任务运用到图形化用户交互模型中而设计的。随着标准输入输出设备的出现，开发人员只需要将精力集中在业务逻辑的分析与实现上。后来被推荐为Oracle旗下Sun公司Java EE平台的设计模式，并且受到越来越多的使用ColdFusion和PHP的开发者的欢迎。现在虽然不再使用原来的分工方式，但是这种分工的思想被沿用下来，广泛应用于软件工程中，是一种典型并且应用广泛的软件架构模式。后来，MVC的思想被应用在了Ｗeb开发方面，被称为Ｗeb MVC框架。</p></div> <p><strong>MVC模式说明</strong></p> <p><img src="/assets/img/image-20210921122420225.c7f16ec3.png" alt="image-20210921122420225"></p> <ul><li>M全拼为Model，主要封装对数据库层的访问，对数据库中的数据进行增、删、改、查操作。</li> <li>V全拼为View，用于封装结果，生成页面展示的html内容。</li> <li>C全拼为Controller，用于接收请求，处理业务逻辑，与Model和View交互，返回结果。</li></ul> <p><strong>Django的MVT</strong></p> <p><img src="/assets/img/image-20210921122734753.e66cdcb1.png" alt="image-20210921122734753"></p> <ul><li>M全拼为Model，与MVC中的M功能相同，负责和数据库交互，进行数据处理。</li> <li>V全拼为View，与MVC中的C功能相同，接收请求，进行业务处理，返回应答。</li> <li>T全拼为Template，与MVC中的V功能相同，负责封装构造要返回的html。</li></ul> <h2 id="三、工程搭建">三、工程搭建</h2> <p>环境搭建在Win10系统上，命令跟Mac和Linux会有很大差别，使用相应命令时自行百度即可，下面使用的是git命令行操作的结果</p> <h3 id="_01-环境安装">01 | 环境安装</h3> <h4 id="准备工作">准备工作</h4> <ol><li><p>检查Python环境：Django 1.11需要Python 2.7或Python 3.4以上的版本；Django 2.0需要Python 3.4以上的版本；Django 2.1需要Python 3.5以上的版本。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Administrator@DESKTOP-TVEH0VN MINGW64 ~/Desktop
$ python --version
Python <span class="token number">3.8</span>.10

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Administrator@DESKTOP-TVEH0VN MINGW64 ~/Desktop
$ python
Python <span class="token number">3.8</span>.10 <span class="token punctuation">(</span>default, May <span class="token number">19</span> <span class="token number">2021</span>, <span class="token number">13</span>:12:57<span class="token punctuation">)</span> <span class="token punctuation">[</span>MSC v.1916 <span class="token number">64</span> bit <span class="token punctuation">(</span>AMD64<span class="token punctuation">)</span><span class="token punctuation">]</span> :: An
aconda, Inc. on win32

Warning:
This Python interpreter is <span class="token keyword">in</span> a conda environment, but the environment has
not been activated.  Libraries may fail to load.  To activate this environment
please see https://conda.io/activation

Type <span class="token string">&quot;help&quot;</span>, <span class="token string">&quot;copyright&quot;</span>, <span class="token string">&quot;credits&quot;</span> or <span class="token string">&quot;license&quot;</span> <span class="token keyword">for</span> <span class="token function">more</span> information.
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">import</span> sys
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys.version
<span class="token string">'3.8.10 (default, May 19 2021, 13:12:57) [MSC v.1916 64 bit (AMD64)]'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys.version_info
sys.version_info<span class="token punctuation">(</span>major<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">minor</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">micro</span><span class="token operator">=</span><span class="token number">10</span>, <span class="token assign-left variable">releaselevel</span><span class="token operator">=</span><span class="token string">'final'</span>, <span class="token assign-left variable">serial</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li><p>创建项目文件夹并切换到该目录</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Administrator@DESKTOP-TVEH0VN MINGW64 /d/project_study
$ <span class="token function">mkdir</span> django-study
$ <span class="token builtin class-name">cd</span> django-study
Administrator@DESKTOP-TVEH0VN MINGW64 /d/project_study/django-study
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>创建并激活虚拟环境。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Administrator@DESKTOP-TVEH0VN MINGW64 /d/project_study/django-study
$ python -m venv venv
$ <span class="token builtin class-name">cd</span> venv/Scripts
$ <span class="token builtin class-name">source</span> venv/Scripts/activate
<span class="token punctuation">(</span>venv<span class="token punctuation">)</span> 
Administrator@DESKTOP-TVEH0VN MINGW64 /d/project_study/django-study
$ 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>说明：上面使用了Python自带的venv模块完成了虚拟环境的创建，当然也可以使用virtualenv或pipenv这样的工具</p></blockquote></li> <li><p>更新包管理工具pip。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">(</span>venv<span class="token punctuation">)</span> D:<span class="token punctuation">\</span>project_study<span class="token punctuation">\</span>django-study<span class="token operator">&gt;</span>pip <span class="token function">install</span> -U pip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或</p> <div class="language-Shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">(</span>venv<span class="token punctuation">)</span> D:<span class="token punctuation">\</span>project_study<span class="token punctuation">\</span>django-study<span class="token operator">&gt;</span>python -m pip <span class="token function">install</span> --upgrade pip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果更新的不是虚拟环境的pip，记得一定要加参数<code>--user</code>，给足权限，否则会报错：<code>ERROR: Could not install packages due to an EnvironmentError: [WinError 5] 拒绝访问。: 'd:\\project_study\\django-study\\venv\\scripts\\pip.exe' Consider using the --user option or check the permissions.</code></p> <p><mark>出现这个错误的时候旧的pip也会被删除，只能使用命令<code>easy_install pip</code>将pip安装回来</mark></p> <div class="custom-block tip"><p class="custom-block-title">Tips</p> <p>请注意终端提示符发生的变化，前面的<code>(venv)</code>说明我们已经进入虚拟环境，而虚拟环境下的python和pip已经是Python3的解释器和包管理工具了。</p></div></li> <li><p>设置镜像源</p> <div class="language-cmd line-numbers-mode"><pre class="language-text"><code>pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h4 id="安装django">安装Django</h4> <p>安装最新版本：</p> <div class="language-Shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">(</span>venv<span class="token punctuation">)</span>$ pip <span class="token function">install</span> django
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或指定版本号来安装对应的Django的版本。</p> <div class="language-Shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">(</span>venv<span class="token punctuation">)</span>$ pip <span class="token function">install</span> <span class="token assign-left variable">django</span><span class="token operator">==</span><span class="token number">2.1</span>.8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="复习虚拟环境和pip的命令">复习虚拟环境和pip的命令</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 虚拟环境</span>
python -m venv <span class="token operator">&lt;</span>env-name<span class="token operator">&gt;</span>  <span class="token comment"># 创建虚拟环境</span>
<span class="token function">rm</span> -rf venv  <span class="token comment"># 直接删除虚拟环境文件夹就是删除虚拟环境</span>
<span class="token builtin class-name">source</span> venv/Scripts/activate  <span class="token comment"># 进入虚拟环境、查看所有虚拟环境</span>
deactivate  <span class="token comment"># 退出虚拟环境</span>

<span class="token comment"># pip</span>
pip <span class="token function">install</span>  <span class="token comment"># 安装依赖包</span>
pip uninstall  <span class="token comment"># 卸载依赖包</span>
pip list  <span class="token comment"># 查看已安装的依赖库</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_02-创建工程">02 | 创建工程</h3> <p>在django中，项目工程目录可以借助django提供的命令帮助我们创建。</p> <h4 id="创建">创建</h4> <p>创建工程的命令为：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>django-admin startproject 工程名称
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>例如：想要在桌面的code目录中创建一个名为demo的项目工程，可执行如下命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> ~/Desktop/code
django-admin startproject demo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行后，会多出一个新目录名为demo，此即为新创建的工程目录。</p> <h4 id="工程目录说明">工程目录说明</h4> <p>查看创建的工程目录，结构如下</p> <p><img src="/assets/img/project_dir.a887279c.png" alt="工程目录"></p> <ul><li>与项目同名的目录，此处为demo。</li> <li><strong>settings.py</strong> 是项目的整体配置文件。</li> <li><strong>urls.py</strong> 是项目的URL配置文件。</li> <li><strong>wsgi.py</strong> 是项目与WSGI兼容的Web服务器入口。</li> <li><strong>manage.py</strong> 是项目管理文件，通过它管理项目。</li></ul> <h4 id="运行开发服务器">运行开发服务器</h4> <p>在开发阶段，为了能够快速预览到开发的效果，django提供了一个纯python编写的轻量级web服务器，仅在开发阶段使用。</p> <p>运行服务器命令如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python manage.py runserver ip:端口
或：
python manage.py runserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>可以不写IP和端口，默认IP是127.0.0.1，默认端口为8000</strong>。</p> <p>启动后可见如下信息：</p> <p><img src="/assets/img/runserver.4b6206b2.png" alt="runserver"></p> <p>在浏览器中输入网址“127.0.0.1:8000”便可看到效果</p> <ul><li>django默认工作在调式Debug模式下，如果增加、修改、删除文件，服务器会自动重启。</li> <li>按ctrl+c停止服务器。</li></ul> <h3 id="_03-创建子应用">03 | 创建子应用</h3> <p>在Web应用中，通常有一些业务功能模块是在不同的项目中都可以复用的，故在开发中通常将工程项目拆分为不同的子功能模块，各功能模块间可以保持相对的独立，在其他工程项目中需要用到某个特定功能模块时，可以将该模块代码整体复制过去，达到复用。</p> <p>在Flask框架中也有类似子功能应用模块的概念，即蓝图Blueprint。</p> <p><strong>Django的视图编写是放在子应用中的。</strong></p> <h4 id="创建-2">创建</h4> <p>在django中，创建子应用模块目录仍然可以通过命令来操作，即：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python manage.py startapp 子应用名称
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>manage.py</strong> 为上述创建工程时自动生成的管理文件。</p> <p>例如，在刚才创建的demo工程中，想要创建一个用户users子应用模块，可执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> ~/Desktop/code/demo
python manage.py startapp <span class="token function">users</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行后，可以看到工程目录中多出了一个名为users的子目录。</p> <h4 id="子应用目录说明">子应用目录说明</h4> <p>查看此时的工程目录，结构如下：</p> <p><img src="/assets/img/app_dir.807b1f7c.png" alt="子应用目录"></p> <ul><li><strong>admin.py</strong> 文件跟网站的后台管理站点配置相关。</li> <li><strong>apps.py</strong> 文件用于配置当前子应用的相关信息。</li> <li><strong>migrations</strong> 目录用于存放数据库迁移历史文件。</li> <li><strong>models.py</strong> 文件用户保存数据库模型类。</li> <li><strong>tests.py</strong> 文件用于开发测试用例，编写单元测试。</li> <li><strong>views.py</strong> 文件用于编写Web应用视图。</li></ul> <h4 id="注册安装子应用">注册安装子应用</h4> <p>创建出来的子应用目录文件虽然被放到了工程项目目录中，但是django工程并不能立即直接使用该子应用，需要注册安装后才能使用。</p> <p>在工程配置文件settings.py中，<strong>INSTALLED_APPS</strong>项保存了工程中已经注册安装的子应用，初始工程中的INSTALLED_APPS如下：</p> <p><img src="/assets/img/image-20210921161911410.af1a2f86.png" alt="image-20210921161911410"></p> <p><strong>注册安装一个子应用的方法，即是将子应用的配置信息文件apps.py中的Config类添加到INSTALLED_APPS列表中。</strong></p> <p>例如，将刚创建的users子应用添加到工程中，可在INSTALLED_APPS列表中添加 <strong>'users.apps.UsersConfig'</strong></p> <p><img src="/assets/img/image-20210921161844459.450fe3d1.png" alt="image-20210921161844459"></p> <h3 id="_04-创建视图">04 | 创建视图</h3> <p>同Flask框架一样，Django也用视图来编写Web应用的业务逻辑。</p> <p>Django的视图是定义在子应用的views.py中的。</p> <h4 id="创建-3">创建</h4> <p>打开刚创建的users模块，在views.py中编写视图代码。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse

<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    index视图
    :param request: 包含了请求信息的请求对象
    :return: 响应对象
    &quot;&quot;&quot;</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;hello the world!&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>说明：</p> <ul><li>视图函数的第一个传入参数必须定义，用于接收Django构造的包含了请求数据的<strong>HttpReqeust</strong>对象，通常名为<strong>request</strong>。</li> <li>视图函数的返回值必须为一个响应对象，不能像Flask一样直接返回一个字符串，可以将要返回的字符串数据放到一个<strong>HTTPResponse</strong>对象中。</li></ul> <h4 id="定义路由url">定义路由URL</h4> <p><strong>1) 在子应用中新建一个urls.py文件用于保存该应用的路由</strong></p> <p><img src="/assets/img/image-20210921162047624.79c56c60.png" alt="image-20210921162047624"></p> <p><strong>2) 在users/urls.py文件中定义路由信息</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

<span class="token comment"># urlpatterns是被django自动识别的路由列表变量</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># 每个路由信息都需要使用url函数来构造</span>
    <span class="token comment"># url(路径, 视图)</span>
    url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>3) 在工程总路由demo/urls.py中添加子应用的路由数据</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># django默认包含的</span>

    <span class="token comment"># 添加</span>
    url<span class="token punctuation">(</span><span class="token string">r'^users/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'users.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>使用include来将子应用users里的全部路由包含进工程路由中；</li> <li><strong>r'^users/'</strong> 决定了users子应用的所有路由都以 <strong>/users/</strong> 开头，如我们刚定义的视图index，其最终的完整访问路径为 <strong>/users/index/</strong>。</li></ul> <p><strong>include</strong> 函数除了可以传递字符串之外，也可以直接传递应用的urls模块，如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">import</span> users<span class="token punctuation">.</span>urls  <span class="token comment"># 先导入应用的urls模块</span>

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># url(r'^users/', include('users.urls')),</span>
    url<span class="token punctuation">(</span><span class="token string">r'^users/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span>users<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 添加应用的路由</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>4) 启动运行</strong></p> <p>重新启动django程序</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python manage.py runserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在浏览器中输入网址<strong>127.0.0.1:8000/users/index/</strong> 可看到返回的信息</p> <p><img src="/assets/img/image-20210921162512548.d8b52e2c.png" alt="image-20210921162512548"></p> <h2 id="四、配置">四、配置</h2> <h3 id="_01-配置文件settings">01 | 配置文件settings</h3> <h4 id="base-dir">BASE_DIR</h4> <p>当前工程的根目录，Django会依此来定位工程内的相关文件，我们也可以使用该参数来构造文件路径。</p> <h4 id="debug">DEBUG</h4> <p>调试模式，创建工程后初始值为<strong>True</strong>，即默认工作在调试模式下。</p> <p>作用：</p> <ul><li>Django程序出现异常时，向前端显示详细的错误追踪信息，</li></ul> <p><strong>注意：部署线上运行的Django不要运行在调式模式下，记得修改DEBUG=False。</strong></p> <h4 id="本地语言与时区">本地语言与时区</h4> <p>初始化的工程默认语言和时区为英语和UTC标准时区</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">'en-us'</span>  <span class="token comment"># 语言</span>
TIME_ZONE <span class="token operator">=</span> <span class="token string">'UTC'</span>  <span class="token comment"># 时区</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>将语言和时区修改为中国大陆信息</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">'zh-hans'</span>
TIME_ZONE <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_02-静态文件">02 | 静态文件</h3> <p>项目中的CSS、图片、js都是静态文件。一般会将静态文件放到一个单独的目录中，以方便管理。在html页面中调用时，也需要指定静态文件的路径，Django中提供了一种解析的方式配置静态文件路径。静态文件可以放在项目根目录下，也可以放在应用的目录下，由于有些静态文件在项目中是通用的，所以推荐放在项目的根目录下，方便管理。</p> <p>为了提供静态文件，需要配置两个参数：</p> <ul><li><strong>STATICFILES_DIRS=[]</strong> 存放查找静态文件的目录 接收的是<strong>list</strong></li> <li><strong>STATIC_URL</strong> 访问静态文件的URL前缀</li></ul> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>Django 仅在调试模式下（DEBUG=True）能对外提供静态文件。</p> <p>当DEBUG=False工作在生产模式时，Django不再对外提供静态文件，需要是用collectstatic命令来收集静态文件并交由其他静态文件服务器来提供。（详细在部署时会讲）</p></div> <h3 id="_03-路由说明">03 | 路由说明</h3> <p><img src="/assets/img/view_process.bb2e0b33.png" alt="视图处理流程"></p> <h4 id="路由定义位置">路由定义位置</h4> <p>Django的主要路由信息定义在工程同名目录下的urls.py文件中，该文件是Django解析路由的入口。</p> <p>每个子应用为了保持相对独立，可以在各个子应用中定义属于自己的urls.py来保存该应用的路由。然后用主路由文件包含各应用的子路由数据。</p> <p>除了上述方式外，也可将工程的全部路由信息都定义在主路由文件中，子应用不再设置urls.py。如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>from django.conf.urls import url
from django.contrib import admin
import users.views

urlpatterns = [
    url(r'^admin/', admin.site.urls),
    url(r'^users/index/$', users.views.index)
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="路由解析顺序">路由解析顺序</h4> <p>Django在接收到一个请求时，从主路由文件中的urlpatterns列表中以由上至下的顺序查找对应路由规则，如果发现规则为include包含，则再进入被包含的urls中的urlpatterns列表由上至下进行查询。</p> <p>值得关注的==<strong>由上至下</strong>的顺序，有可能会使上面的路由屏蔽掉下面的路由，带来非预期结果==。例如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^say'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>say<span class="token punctuation">)</span><span class="token punctuation">,</span>
    url<span class="token punctuation">(</span><span class="token string">r'^sayhello'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>sayhello<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>即使访问sayhello/路径，预期应该进入sayhello视图执行，但实际优先查找到了say路由规则也与sayhello/路径匹配，实际进入了say视图执行。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><strong>需要注意定义路由的顺序，避免出现屏蔽效应。</strong></p></div> <h4 id="路由命名与reverse反解析-逆向">路由命名与reverse反解析（逆向）</h4> <p><strong>1）路由命名</strong></p> <p>在定义路由的时候，可以为路由命名，方便查找特定视图的具体路径信息。</p> <ul><li><p>在使用include函数定义路由时，可以使用namespace参数定义路由的命名空间，如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>url<span class="token punctuation">(</span><span class="token string">r'^users/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'users.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>命名空间表示，凡是users.urls中定义的路由，均属于namespace指明的users名下。</p> <p><strong>命名空间的作用：避免不同应用中的路由使用了相同的名字发生冲突，使用命名空间区别开</strong></p></li> <li><p>在定义普通路由时，可以使用name参数指明路由的名字，如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    url<span class="token punctuation">(</span><span class="token string">r'^say'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>say<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'say'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul> <p><strong>2）reverse反解析</strong></p> <p>使用reverse函数，可以根据路由名称，返回具体的路径，如：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse  <span class="token comment"># 注意导包路径</span>

<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;hello the world!&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">say</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'users:index'</span><span class="token punctuation">)</span>  <span class="token comment"># 返回 /users/index/</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>对于未指明namespace的，reverse(路由name)</li> <li>对于指明namespace的，reverse(命名空间namespace:路由name)</li></ul> <h4 id="路径结尾斜线-的说明">路径结尾斜线/的说明</h4> <p>Django中定义路由时，通常以斜线/结尾，其好处是用户访问不以斜线/结尾的相同路径时，Django会把用户重定向到以斜线/结尾的路径上，而不会返回404不存在。如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>用户访问 index 或者 index/ 网址，均能访问到index视图。</p> <p><strong>说明：</strong></p> <p>虽然路由结尾带/能带来上述好处，但是却违背了HTTP中URL表示资源位置路径的设计理念。</p> <p>是否结尾带/以所属公司定义风格为准。</p> <h2 id="五、请求与响应">五、请求与响应</h2> <h3 id="_01-请求request">01 | 请求Request</h3> <p>回想一下，利用HTTP协议向服务器传参有几种途径？</p> <ul><li>提取URL的特定部分，如/weather/beijing/2018，可以在服务器端的路由中用正则表达式截取；</li> <li>查询字符串（query string)，形如key1=value1&amp;key2=value2；</li> <li>请求体（body）中发送的数据，比如表单数据、json、xml；</li> <li>在http报文的头（header）中。</li></ul> <h4 id="url路径参数">URL路径参数</h4> <p>在定义路由URL时，可以使用正则表达式提取参数的方法从URL中获取请求参数，Django会将提取的参数直接传递到视图的传入参数中。</p> <ul><li><p>未命名参数按定义顺序传递， 如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>url<span class="token punctuation">(</span><span class="token string">r'^weather/([a-z]+)/(\d{4})/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>weather<span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token keyword">def</span> <span class="token function">weather</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> city<span class="token punctuation">,</span> year<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'city=%s'</span> <span class="token operator">%</span> city<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'year=%s'</span> <span class="token operator">%</span> year<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>命名参数按名字传递，如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>url<span class="token punctuation">(</span><span class="token string">r'^weather/(?P&lt;city&gt;[a-z]+)/(?P&lt;year&gt;\d{4})/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>weather<span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token keyword">def</span> <span class="token function">weather</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> year<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'city=%s'</span> <span class="token operator">%</span> city<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'year=%s'</span> <span class="token operator">%</span> year<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <h4 id="django中的querydict对象">Django中的QueryDict对象</h4> <p>定义在django.http.QueryDict</p> <p>HttpRequest对象的属性GET、POST都是QueryDict类型的对象</p> <p>与python字典不同，QueryDict类型的对象用来处理同一个键带有多个值的情况</p> <ul><li><p>方法get()：根据键获取值</p> <p><mark>如果一个键同时拥有多个值将获取最后一个值</mark></p> <p>如果键不存在则==返回None值==，可以设置默认值进行后续处理</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">dict</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'键'</span><span class="token punctuation">,</span>默认值<span class="token punctuation">)</span>
可简写为
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token string">'键'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>方法getlist()：根据键获取值，值以列表返回，可以获取指定键的所有值</p> <p>如果键不存在则==返回空列表[]==，可以设置默认值进行后续处理</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">dict</span><span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'键'</span><span class="token punctuation">,</span>默认值<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h4 id="查询字符串query-string">查询字符串Query String</h4> <p>获取请求路径中的查询字符串参数（形如?k1=v1&amp;k2=v2），可以通过request.GET属性获取，返回QueryDict对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># /qs/?a=1&amp;b=2&amp;a=3</span>

<span class="token keyword">def</span> <span class="token function">qs</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
    alist <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment"># 3</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>  <span class="token comment"># 2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>alist<span class="token punctuation">)</span>  <span class="token comment"># ['1', '3']</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>重要：查询字符串不区分请求方式，即假使客户端进行POST方式的请求，依然可以通过request.GET获取请求中的查询字符串数据。</strong></p> <h4 id="请求体">请求体</h4> <p>请求体数据格式不固定，可以是表单类型字符串，可以是JSON字符串，可以是XML字符串，应区别对待。</p> <p>可以发送请求体数据的请求方式有<strong>POST</strong>、<strong>PUT</strong>、<strong>PATCH</strong>、<strong>DELETE</strong>。</p> <p><strong>Django默认开启了CSRF防护</strong>，会对上述请求方式进行CSRF防护验证，在测试时可以关闭CSRF防护机制，方法为在settings.py文件中注释掉CSRF中间件，如：</p> <p><img src="/assets/img/csrf_middleware.9cf7589f.png" alt="注释CSRF中间件"></p> <p><strong>1）表单类型 Form Data</strong></p> <p>前端发送的表单类型的请求体数据，可以通过request.POST属性获取，返回QueryDict对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_body</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
    alist <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>alist<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>重要：request.POST只能用来获取POST方式的请求体表单数据。</strong></p> <p><strong>2）非表单类型 Non-Form Data</strong></p> <p>非表单类型的请求体数据，Django无法自动解析，可以通过<strong>request.body</strong>属性获取最原始的请求体数据，自己按照请求体格式（JSON、XML等）进行解析。<strong>request.body返回bytes类型。</strong></p> <p>例如要获取请求体中的如下JSON数据</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;a&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;b&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以进行如下方法操作：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> json

<span class="token keyword">def</span> <span class="token function">get_body_json</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_str <span class="token operator">=</span> request<span class="token punctuation">.</span>body
    json_str <span class="token operator">=</span> json_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># python3.6 无需执行此步</span>
    req_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>req_data<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>req_data<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="请求头">请求头</h4> <p>可以通过<strong>request.META</strong>属性获取请求头headers中的数据，<strong>request.META为字典类型</strong>。</p> <p>常见的请求头如：</p> <ul><li><code>CONTENT_LENGTH</code> – The length of the request body (as a string).</li> <li><code>CONTENT_TYPE</code> – The MIME type of the request body.</li> <li><code>HTTP_ACCEPT</code> – Acceptable content types for the response.</li> <li><code>HTTP_ACCEPT_ENCODING</code> – Acceptable encodings for the response.</li> <li><code>HTTP_ACCEPT_LANGUAGE</code> – Acceptable languages for the response.</li> <li><code>HTTP_HOST</code> – The HTTP Host header sent by the client.</li> <li><code>HTTP_REFERER</code> – The referring page, if any.</li> <li><code>HTTP_USER_AGENT</code> – The client’s user-agent string.</li> <li><code>QUERY_STRING</code> – The query string, as a single (unparsed) string.</li> <li><code>REMOTE_ADDR</code> – The IP address of the client.</li> <li><code>REMOTE_HOST</code> – The hostname of the client.</li> <li><code>REMOTE_USER</code> – The user authenticated by the Web server, if any.</li> <li><code>REQUEST_METHOD</code> – A string such as <code>&quot;GET&quot;</code> or <code>&quot;POST&quot;</code>.</li> <li><code>SERVER_NAME</code> – The hostname of the server.</li> <li><code>SERVER_PORT</code> – The port of the server (as a string).</li></ul> <p>具体使用如:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_headers</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>META<span class="token punctuation">[</span><span class="token string">'CONTENT_TYPE'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="其他常用httprequest对象属性">其他常用HttpRequest对象属性</h4> <ul><li><p><strong>method</strong>：一个字符串，表示请求使用的HTTP方法，常用值包括：'GET'、'POST'。</p></li> <li><p><strong>user：请求的用户对象。</strong></p></li> <li><p>path：一个字符串，表示请求的页面的完整路径，不包含域名和参数部分。</p></li> <li><p>encoding：一个字符串，表示提交的数据的编码方式。</p> <ul><li>如果为None则表示使用浏览器的默认设置，一般为utf-8。</li> <li>这个属性是可写的，可以通过修改它来修改访问表单数据使用的编码，接下来对属性的任何访问将使用新的encoding值。</li></ul></li> <li><p>FILES：一个类似于字典的对象，包含所有的上传文件。</p></li></ul> <h3 id="_02-响应response">02 | 响应Response</h3> <p>视图在接收请求并处理后，必须返回HttpResponse对象或子对象。HttpRequest对象由Django创建，HttpResponse对象由开发人员创建</p> <h4 id="httpresponse">HttpResponse</h4> <p>可以使用<strong>django.http.HttpResponse</strong>来构造响应对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HttpResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>响应体<span class="token punctuation">,</span> content_type<span class="token operator">=</span>响应体数据类型<span class="token punctuation">,</span> status<span class="token operator">=</span>状态码<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可通过HttpResponse对象属性来设置响应体、状态码：</p> <ul><li>content：表示返回的内容。</li> <li>status_code：返回的HTTP响应状态码。</li></ul> <p>响应头可以直接将HttpResponse对象当做字典进行响应头键值对的设置：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>response <span class="token operator">=</span> HttpResponse<span class="token punctuation">(</span><span class="token punctuation">)</span>
response<span class="token punctuation">[</span><span class="token string">'Itcast'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Python'</span>  <span class="token comment"># 自定义响应头Itcast, 值为Python</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse

<span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'itcast python'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span>
    或者
    response <span class="token operator">=</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'itcast python'</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">400</span>
    response<span class="token punctuation">[</span><span class="token string">'Itcast'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Python'</span>
    <span class="token keyword">return</span> response
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="httpresponse子类">HttpResponse子类</h4> <p>Django提供了一系列HttpResponse的子类，可以快速设置状态码</p> <ul><li>HttpResponseRedirect 301</li> <li>HttpResponsePermanentRedirect 302</li> <li>HttpResponseNotModified 304</li> <li>HttpResponseBadRequest 400</li> <li>HttpResponseNotFound 404</li> <li>HttpResponseForbidden 403</li> <li>HttpResponseNotAllowed 405</li> <li>HttpResponseGone 410</li> <li>HttpResponseServerError 500</li></ul> <h4 id="jsonresponse">JsonResponse</h4> <p>若要返回json数据，可以使用JsonResponse来构造响应对象，作用：</p> <ul><li>帮助我们将数据转换为json字符串</li> <li>设置响应头<strong>Content-Type</strong>为 <strong>application/json</strong></li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> JsonResponse

<span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'beijing'</span><span class="token punctuation">,</span> <span class="token string">'subject'</span><span class="token punctuation">:</span> <span class="token string">'python'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="redirect重定向">redirect重定向</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> redirect

<span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/index.html'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_03-cookie">03 | Cookie</h3> <blockquote><p>Cookie，有时也用其复数形式Cookies，指某些网站为了辨别用户身份、进行session跟踪而储存在用户本地终端上的数据（通常经过加密）。</p></blockquote> <hr> <p>Cookie最早是网景公司的前雇员Lou Montulli在1993年3月的发明。Cookie是由服务器端生成，发送给User-Agent（一般是浏览器），浏览器会将Cookie的key/value保存到某个目录下的文本文件内，下次请求同一网站时就发送该Cookie给服务器（前提是浏览器设置为启用cookie）。Cookie名称和值可以由服务器端开发自己定义，这样服务器可以知道该用户是否是合法用户以及是否需要重新登录等。服务器可以利用Cookies包含信息的任意性来筛选并经常性维护这些信息，以判断在HTTP传输中的状态。Cookies最典型<strong>记住用户名</strong>。</p> <hr> <p>Cookie是存储在浏览器中的一段纯文本信息，建议不要存储敏感信息如密码，因为电脑上的浏览器可能被其它人使用。</p> <h4 id="cookie的特点">Cookie的特点</h4> <ul><li>Cookie以键值对Key-Value形势进行信息的存储。</li> <li>Cookie基于域名安全，不同域名的Cookie是不能互相访问的</li></ul> <h4 id="设置cookie">设置Cookie</h4> <p>可以通过<strong>HttpResponse</strong>对象中的<strong>set_cookie</strong>方法来设置cookie。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HttpResponse<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span>cookie名<span class="token punctuation">,</span> value<span class="token operator">=</span>cookie值<span class="token punctuation">,</span> max_age<span class="token operator">=</span>cookie有效期<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>max_age</strong> 单位为秒，默认为<strong>None</strong>。如果是临时cookie，可将max_age设置为None。</li></ul> <h4 id="读取cookie">读取Cookie</h4> <p>可以通过<strong>HttpRequest</strong>对象的<strong>COOKIES</strong>属性来读取本次请求携带的cookie值。<strong>request.COOKIES为字典类型</strong>。</p> <h3 id="_05-session">05 | Session</h3> <blockquote><p>Session:在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。Session 对象最常见的一个用法就是存储用户的首选项。</p></blockquote> <h4 id="session-的作用">Session 的作用</h4> <p>Session 的作用就是它在 Web服务器上保持用户的状态信息供在任何时间从任何设备上的页面进行访问。因为浏览器不需要存储任何这种信息，所以可以使用任何浏览器，即使是像 Pad 或手机这样的浏览器设备。</p> <p>保持会话状态!</p> <h4 id="session的特点">Session的特点</h4> <ol><li>依赖cookies</li> <li>存储敏感、重要的信息</li> <li>支持更多字节</li> <li>Session共享问题</li></ol> <h4 id="session配置和存储">Session配置和存储</h4> <p><strong>1）启用Session</strong></p> <p><mark>Django项目默认启用Session</mark></p> <p>可以在settings.py文件中查看，如图所示</p> <p><img src="/assets/img/session_middleware.75b5a630.png" alt="session中间件"></p> <p>如需禁用session，将上图中的session中间件注释掉即可。</p> <p><strong>2）存储方式</strong></p> <p>在settings.py文件中，可以设置session数据的存储方式，可以保存在数据库、本地缓存等。</p> <ul><li><p>数据库</p> <p>存储在数据库中，如下设置可以写，也可以不写，<strong>这是默认存储方式</strong>。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SESSION_ENGINE<span class="token operator">=</span><span class="token string">'django.contrib.sessions.backends.db'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果存储在数据库中，需要在项INSTALLED_APPS中安装Session应用</p> <p><img src="/assets/img/session_app.71f0cefe.png" alt="session_app"></p> <p>数据库中的表如图所示</p> <p><img src="/assets/img/session_database.97be712d.png" alt="session数据库"></p> <p>表结构如下:</p> <p><img src="/assets/img/session_table.1d702e89.png" alt="session表结构"></p> <p>由表结构可知，操作Session包括三个数据：键，值，过期时间。</p></li> <li><p>本地缓存</p> <p>存储在本机内存中，如果丢失则不能找回，比数据库的方式读写更快。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SESSION_ENGINE<span class="token operator">=</span><span class="token string">'django.contrib.sessions.backends.cache'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>混合存储</p> <p>优先从本机内存中存取，如果没有则从数据库中存取。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SESSION_ENGINE<span class="token operator">=</span><span class="token string">'django.contrib.sessions.backends.cached_db'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>Redis</p> <p>在redis中保存session，需要引入第三方扩展，我们可以使用<strong>django-redis</strong>来解决。</p> <p>1） 安装扩展</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>pip install django<span class="token operator">-</span>redis
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2）配置</p> <p>在settings.py文件中做如下设置</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;BACKEND&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.cache.RedisCache&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;LOCATION&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;redis://127.0.0.1:6379/1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;CLIENT_CLASS&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.client.DefaultClient&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
SESSION_ENGINE <span class="token operator">=</span> <span class="token string">&quot;django.contrib.sessions.backends.cache&quot;</span>
SESSION_CACHE_ALIAS <span class="token operator">=</span> <span class="token string">&quot;default&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">注意</p> <p>如果redis的ip地址不是本地回环127.0.0.1，而是其他地址，访问Django时，可能出现Redis连接错误，如下：</p> <p><img src="/assets/img/redis_connect_error.2fd8ceeb.png" alt="redis连接错误"></p></div></li></ul> <p>解决方法：</p> <p>修改redis的配置文件，添加特定ip地址。</p> <p>打开redis的配置文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">vim</span> /etc/redis/redis.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在如下配置项进行修改（如要添加10.211.55.5地址）</p> <p><img src="/assets/img/modify_redis_config.ef5830f3.png" alt="修改redis配置文件"></p> <p>重新启动redis服务</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">service</span> redis-server restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="session操作">Session操作</h4> <p>通过HttpRequest对象的session属性进行会话的读写操作。</p> <p>1） 以键值对的格式写session。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>request.session['键']=值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2）根据键读取值。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>request.session.get('键',默认值)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3）清除所有session，在存储中删除值部分。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>request.session.clear()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>4）清除session数据，在存储中删除session的整条数据。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>request.session.flush()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>5）删除session中的指定键及值，在存储中只删除某个键及对应的值。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>del request.session['键']
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>6）设置session的有效期</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>request.session.set_expiry(value)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果value是一个整数，session将在value秒没有活动后过期。</li> <li>如果value为0，那么用户session的Cookie将在用户的浏览器关闭时过期。</li> <li>如果value为None，那么session有效期将采用系统默认值，<strong>默认为两周</strong>，可以通过在settings.py中设置<strong>SESSION_COOKIE_AGE</strong>来设置全局默认值。</li></ul> <h2 id="六、类视图与中间件">六、类视图与中间件</h2> <h3 id="_01-类视图">01 | 类视图</h3> <h4 id="定义类视图">定义类视图</h4> <p><strong>1）类视图引入</strong></p> <p>以函数的方式定义的视图称为<strong>函数视图</strong>，函数视图便于理解。但是遇到一个视图对应的路径提供了多种不同HTTP请求方式的支持时，便需要在一个函数中编写不同的业务逻辑，代码可读性与复用性都不佳。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code> <span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;处理注册&quot;&quot;&quot;</span>

    <span class="token comment"># 获取请求方法，判断是GET/POST请求</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token comment"># 处理GET请求，返回注册页面</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'register.html'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 处理POST请求，实现注册逻辑</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'这里实现注册逻辑'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在Django中也可以使用类来定义一个视图，称为<strong>类视图</strong>。</p> <p>使用类视图可以将视图对应的不同请求方式以类中的不同方法来区别定义。如下所示</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> View

<span class="token keyword">class</span> <span class="token class-name">RegisterView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;类视图：处理注册&quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理GET请求，返回注册页面&quot;&quot;&quot;</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'register.html'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;处理POST请求，实现注册逻辑&quot;&quot;&quot;</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'这里实现注册逻辑'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>类视图的好处：</p> <ul><li><strong>代码可读性好</strong></li> <li><strong>类视图相对于函数视图有更高的复用性</strong>， 如果其他地方需要用到某个类视图的某个特定逻辑，直接继承该类视图即可</li></ul> <p><strong>2）类视图使用</strong></p> <p>定义类视图需要继承自Django提供的父类<strong>View</strong>，可使用<code>from django.views.generic import View</code>或者<code>from django.views.generic.base import View</code> 导入，定义方式如上所示。</p> <p><strong>配置路由时，使用类视图的<code>as_view()</code>方法来添加</strong>。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># 视图函数：注册</span>
    <span class="token comment"># url(r'^register/$', views.register, name='register'),</span>
    <span class="token comment"># 类视图：注册</span>
    url<span class="token punctuation">(</span><span class="token string">r'^register/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>RegisterView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="类视图原理">类视图原理</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token decorator annotation punctuation">@classonlymethod</span>
    <span class="token keyword">def</span> <span class="token function">as_view</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">**</span>initkwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Main entry point for a request-response process.
        &quot;&quot;&quot;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略代码<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>initkwargs<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>head <span class="token operator">=</span> self<span class="token punctuation">.</span>get
            self<span class="token punctuation">.</span>request <span class="token operator">=</span> request
            self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
            self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs
            <span class="token comment"># 调用dispatch方法，按照不同请求方式调用不同请求方法</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>dispatch<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略代码<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment"># 返回真正的函数视图</span>
        <span class="token keyword">return</span> view


    <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Try to dispatch to the right method; if a method doesn't exist,</span>
        <span class="token comment"># defer to the error handler. Also defer to the error handler if the</span>
        <span class="token comment"># request method isn't on the approved list.</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>http_method_names<span class="token punctuation">:</span>
            handler <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>http_method_not_allowed<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            handler <span class="token operator">=</span> self<span class="token punctuation">.</span>http_method_not_allowed
        <span class="token keyword">return</span> handler<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>1.调用流程 as_view--&gt;view--&gt;dispatch</p> <p>2.getattr('对象','字符串')</p> <h4 id="类视图使用装饰器">类视图使用装饰器</h4> <p>为类视图添加装饰器，可以使用两种方法。</p> <p>为了理解方便，我们先来定义一个<strong>为函数视图准备的装饰器</strong>（在设计装饰器时基本都以函数视图作为考虑的被装饰对象），及一个要被装饰的类视图。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'自定义装饰器被调用了'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求路径%s'</span> <span class="token operator">%</span> request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapper

<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>1）在URL配置中装饰</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^demo/$'</span><span class="token punctuation">,</span> my_decorate<span class="token punctuation">(</span>DemoView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此种方式最简单，但因装饰行为被放置到了url配置中，单看视图的时候无法知道此视图还被添加了装饰器，不利于代码的完整性，不建议使用。</p> <p><strong>此种方式会为类视图中的所有请求方法都加上装饰器行为</strong>（因为是在视图入口处，分发请求方式前）。</p> <p><strong>2）在类视图中装饰</strong></p> <p>在类视图中使用为函数视图准备的装饰器时，不能直接添加装饰器，需要使用<strong>method_decorator</strong>将其转换为适用于类视图方法的装饰器。</p> <p><strong>method_decorator装饰器使用name参数指明被装饰的方法</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 为全部请求方法添加装饰器</span>
<span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'dispatch'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>


<span class="token comment"># 为特定请求方法添加装饰器</span>
<span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>如果需要为类视图的多个方法添加装饰器，但又不是所有的方法（为所有方法添加装饰器参考上面例子），可以直接在需要添加装饰器的方法上使用method_decorator，如下所示</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> method_decorator

<span class="token comment"># 为特定请求方法添加装饰器</span>
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">)</span>  <span class="token comment"># 为get方法添加了装饰器</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">)</span>  <span class="token comment"># 为post方法添加了装饰器</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 没有为put方法添加装饰器</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'put方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="类视图mixin扩展类">类视图Mixin扩展类</h4> <p>使用面向对象多继承的特性，可以通过定义父类（作为扩展类），在父类中定义想要向类视图补充的方法，类视图继承这些扩展父类，便可实现代码复用。</p> <p>定义的扩展父类名称通常以Mixin结尾。</p> <p>举例如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MyDecoratorMixin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">as_view</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        view <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        view <span class="token operator">=</span> my_decorator<span class="token punctuation">(</span>view<span class="token punctuation">)</span>
        <span class="token keyword">return</span> view

<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>MyDecoratorMixin<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">ListModelMixin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    list扩展类
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">CreateModelMixin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    create扩展类
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">BooksView</span><span class="token punctuation">(</span>CreateModelMixin<span class="token punctuation">,</span> ListModelMixin<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    同时继承两个扩展类，复用list和create方法
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>create<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="_02-中间件">02 | 中间件</h3> <p>Django中的中间件是一个轻量级、底层的插件系统，可以介入Django的请求和响应处理过程，修改Django的输入或输出。中间件的设计为开发者提供了一种无侵入式的开发方式，增强了Django框架的健壮性。</p> <p>我们可以使用中间件，在Django处理视图的不同阶段对输入或输出进行干预。</p> <h4 id="中间件的定义方法">中间件的定义方法</h4> <p>定义一个中间件工厂函数，然后返回一个可以被调用的中间件。</p> <p>中间件工厂函数需要接收一个可以调用的get_response对象。</p> <p>返回的中间件也是一个可以被调用的对象，并且像视图一样需要接收一个request对象参数，返回一个response对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">simple_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 此处编写的代码仅在Django第一次配置和初始化的时候执行一次。</span>

    <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 此处编写的代码会在每个请求处理视图前被调用。</span>

        response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

        <span class="token comment"># 此处编写的代码会在每个请求处理视图之后被调用。</span>

        <span class="token keyword">return</span> response

    <span class="token keyword">return</span> middleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>例如，在users应用中新建一个middleware.py文件，</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'init 被调用'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before request 被调用'</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after response 被调用'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token keyword">return</span> middleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>定义好中间件后，需要在settings.py 文件中添加注册中间件</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token comment"># 'django.middleware.csrf.CsrfViewMiddleware',</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'users.middleware.my_middleware'</span><span class="token punctuation">,</span>  <span class="token comment"># 添加中间件</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>定义一个视图进行测试</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'view 视图被调用'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>执行结果</p> <p><img src="/assets/img/middleware_demo.73769f9f.png" alt="中间件测试"></p> <p><strong>注意：Django运行在调试模式下，中间件init部分有可能被调用两次。</strong></p> <h4 id="执行流程">执行流程</h4> <p><img src="/assets/img/中间件执行流程.b819e1aa.png" alt="中间件执行流程"></p> <h4 id="多个中间件的执行顺序">多个中间件的执行顺序</h4> <ul><li>在请求视图被处理<strong>前</strong>，中间件<strong>由上至下</strong>依次执行</li> <li>在请求视图被处理<strong>后</strong>，中间件<strong>由下至上</strong>依次执行</li></ul> <p><img src="/assets/img/middleware_sequence.b4234dbc.png" alt="中间件顺序"></p> <p>示例：</p> <p>定义两个中间件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'init 被调用'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before request 被调用'</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after response 被调用'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token keyword">return</span> middleware

<span class="token keyword">def</span> <span class="token function">my_middleware2</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'init2 被调用'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before request 2 被调用'</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after response 2 被调用'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
    <span class="token keyword">return</span> middleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注册添加两个中间件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token comment"># 'django.middleware.csrf.CsrfViewMiddleware',</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'users.middleware.my_middleware'</span><span class="token punctuation">,</span>  <span class="token comment"># 添加</span>
    <span class="token string">'users.middleware.my_middleware2'</span><span class="token punctuation">,</span>  <span class="token comment"># 添加</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>执行结果</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>init2 被调用
init 被调用
before request 被调用
before request <span class="token number">2</span> 被调用
view 视图被调用
after response <span class="token number">2</span> 被调用
after response 被调用
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="七、模板-了解">七、模板（了解）</h2> <h3 id="_01-django自带模板使用">01 | Django自带模板使用</h3> <h4 id="模板配置使用">模板配置使用</h4> <p><strong>1）配置</strong></p> <p>在工程中创建模板目录templates。</p> <p>在settings.py配置文件中修改<strong>TEMPLATES</strong>配置项的DIRS值：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.django.DjangoTemplates'</span><span class="token punctuation">,</span>
        <span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 此处修改</span>
        <span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>
                <span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>2） 定义模板</strong></p> <p>在templates目录中新建一个模板文件，如index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{{ city }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>3） 模板渲染</strong></p> <p><strong>Django提供了一个函数render实现模板渲染。</strong></p> <p>render(request对象, 模板文件路径, 模板数据字典)</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render

<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    context<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'北京'</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>context<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="模板语法">模板语法</h4> <p><strong>1）模板变量</strong></p> <p>变量名必须由字母、数字、下划线（不能以下划线开头）和点组成。</p> <p>语法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token punctuation">{</span>变量<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>模板变量可以使python的内建类型，也可以是对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'北京'</span><span class="token punctuation">,</span>
        <span class="token string">'adict'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'西游记'</span><span class="token punctuation">,</span>
            <span class="token string">'author'</span><span class="token punctuation">:</span> <span class="token string">'吴承恩'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'alist'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Title<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> city <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> adict <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> adict<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>  注意字典的取值方法
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> alist <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>  
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> alist<span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>  注意列表的取值方法
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>2）模板语句</strong></p> <ul><li><p>for循环</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> 列表 <span class="token operator">%</span><span class="token punctuation">}</span>

循环逻辑
<span class="token punctuation">{</span><span class="token punctuation">{</span>forloop<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token punctuation">}</span>表示当前是第几次循环，从<span class="token number">1</span>开始
<span class="token punctuation">{</span><span class="token operator">%</span>empty<span class="token operator">%</span><span class="token punctuation">}</span> 列表为空或不存在时执行此逻辑

<span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>if条件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">%</span><span class="token punctuation">}</span>
逻辑<span class="token number">1</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">elif</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">%</span><span class="token punctuation">}</span>
逻辑<span class="token number">2</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">else</span> <span class="token operator">%</span><span class="token punctuation">}</span>
逻辑<span class="token number">3</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>比较运算符如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">==</span>
<span class="token operator">!=</span>
<span class="token operator">&lt;</span>
<span class="token operator">&gt;</span>
<span class="token operator">&lt;=</span>
<span class="token operator">&gt;=</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>布尔运算符如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">and</span>
<span class="token keyword">or</span>
<span class="token keyword">not</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <div class="custom-block tip"><p class="custom-block-title">注意：</p> <p>运算符左右两侧不能紧挨变量或常量，必须有空格</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">%</span><span class="token punctuation">}</span>  <span class="token comment"># 正确</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> a<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">%</span><span class="token punctuation">}</span>  <span class="token comment"># 错误</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <h4 id="过滤器">过滤器</h4> <p>语法如下:</p> <ul><li><p>使用管道符号|来应用过滤器，用于进行计算、转换操作，可以使用在变量、标签中。</p></li> <li><p>如果过滤器需要参数，则使用冒号:传递参数。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>变量<span class="token operator">|</span>过滤器<span class="token punctuation">:</span>参数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <p>列举自带过滤器几个如下：</p> <ul><li><p><strong>safe</strong>，禁用转义，告诉模板这个变量是安全的，可以解释执行</p></li> <li><p><strong>length</strong>，长度，返回字符串包含字符的个数，或列表、元组、字典的元素个数。</p></li> <li><p><strong>default</strong>，默认值，如果变量不存在时则返回默认值。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>data|default:'默认值'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>date</strong>，日期，用于对日期类型的值进行字符串格式化，常用的格式化字符如下：</p> <ul><li>Y表示年，格式为4位，y表示两位的年。</li> <li>m表示月，格式为01,02,12等。</li> <li>d表示日, 格式为01,02等。</li> <li>j表示日，格式为1,2等。</li> <li>H表示时，24进制，h表示12进制的时。</li> <li>i表示分，为0-59。</li> <li>s表示秒，为0-59。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>value|date:&quot;Y年m月j日  H时i分s秒&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <div class="custom-block warning"><p class="custom-block-title">提示</p> <p>template提供的内置过滤器，不够用，不灵活，就可以自己定义一个过滤器</p></div> <ul><li><p>1、在自己的app里建一个templatetags包，在包里创建一个后面要在HTML文件引用的py文件，</p></li> <li><p>2、在py文件中，先导入from django import template ，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  实例化对象register = template.Library()
  创建一个template能认识的函数
  对创建的每一个过滤器，都要用加上装饰器
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/assets/img/customfilter1.6ff0b06f.png" alt="customfilter"></p></li> <li><p>3、在HTML文件中引用</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>3.1 load mytag
3.2 使用过滤器
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <p><img src="/assets/img/customfilter2.764d7d5a.png" alt="customfilter"></p> <p><strong>注意点: templatetags文件夹 要在各自的应用内创建</strong></p> <h4 id="模板继承">模板继承</h4> <p>模板继承和类的继承含义是一样的，主要是为了提高代码重用，减轻开发人员的工作量。</p> <p><strong>父模板</strong></p> <p>如果发现在多个模板中某些内容相同，那就应该把这段内容定义到父模板中。</p> <p>标签block：用于在父模板中预留区域，留给子模板填充差异性的内容，名字不能相同。 为了更好的可读性，建议给endblock标签写上名字，这个名字与对应的block名字相同。父模板中也可以使用上下文中传递过来的数据。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> block 名称 <span class="token operator">%</span><span class="token punctuation">}</span>
预留区域，可以编写默认内容，也可以没有默认内容
<span class="token punctuation">{</span><span class="token operator">%</span> endblock  名称 <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>子模板</strong></p> <p>标签extends：继承，写在子模板文件的第一行。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% extends &quot;父模板路径&quot;%}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>子模版不用填充父模版中的所有预留区域，如果子模版没有填充，则使用父模版定义的默认值。</p> <p>填充父模板中指定名称的预留区域。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% block 名称 %}
实际填充内容
{{ block.super }}用于获取父模板中block的内容
{% endblock 名称 %}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="模板注释">模板注释</h4> <p>1）单行注释语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{#...#}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2）多行注释使用comment标签，语法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> comment <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endcomment <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_02-django中使用jinja2模板">02 | Django中使用jinja2模板</h3> <h4 id="jinja2介绍">jinja2介绍</h4> <blockquote><p>Jinja2：是 Python 下一个被广泛应用的模板引擎，是由Python实现的模板语言，他的设计思想来源于 Django 的模板引擎，并扩展了其语法和一系列强大的功能，尤其是Flask框架内置的模板语言</p></blockquote> <p>由于django默认模板引擎功能不齐全,速度慢，所以我们也可以在Django中使用jinja2, jinja2宣称比django默认模板引擎快10-20倍。</p> <p>Django主流的第三方APP基本上也都同时支持Django默认模板及jinja2，所以要用jinja2也不会有多少障碍。</p> <h4 id="安装jinja2模块">安装jinja2模块</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>    pip install jinja2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="django配置jinja2">Django配置jinja2</h4> <ol><li>在项目文件中创建 jinja2_env.py 文件</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>from jinja2 import Environment

def environment(**options):
    env = Environment(**options)

    return env
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.在settings.py文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.jinja2.Jinja2',#修改1
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS':True,
        'OPTIONS':{
            'environment': 'jinja2_env.environment',# 修改2
            'context_processors':[
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="jinja2模板的使用">jinja2模板的使用</h4> <p>inja2模板的使用绝大多数和Django自带模板一样</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.for循环有差异
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/jinja1.67fe433f.jpg" alt="for循环"></p> <h4 id="jinja2自定义过滤器">jinja2自定义过滤器</h4> <p>在jinja2_env.py文件中自定义过滤器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>from jinja2 import Environment

def environment(**options):
    env = Environment(**options)

    # 2.将自定义的过滤器添加到 环境中
    env.filters['do_listreverse'] = do_listreverse

    return env

# 1.自定义过滤器
def do_listreverse(li):
    if li == &quot;B&quot;:
        return &quot;哈哈&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_03-csrf攻击">03 | CSRF攻击</h3> <ul><li><code>CSRF</code>全拼为<code>Cross Site Request Forgery</code>，译为跨站请求伪造。</li> <li>CSRF指攻击者盗用了你的身份，以你的名义发送恶意请求。
<ul><li>包括：以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账......</li></ul></li> <li>造成的问题：个人隐私泄露以及财产安全。</li></ul> <h4 id="csrf攻击示意图">CSRF攻击示意图</h4> <p>客户端访问服务器时没有同服务器做安全验证</p> <p><img src="/assets/img/CSRF1.e52e2f82.png" alt="CSRF攻击过程"></p> <h4 id="防止-csrf-攻击">防止 CSRF 攻击</h4> <p>步骤</p> <ol><li>在客户端向后端请求界面数据的时候，后端会往响应中的 cookie 中设置 csrf_token 的值</li> <li>在 Form 表单中添加一个隐藏的的字段，值也是 csrf_token</li> <li>在用户点击提交的时候，会带上这两个值向后台发起请求</li> <li>后端接受到请求，以会以下几件事件：
<ul><li>从 cookie中取出 csrf_token</li> <li>从 表单数据中取出来隐藏的 csrf_token 的值</li> <li>进行对比</li></ul></li> <li>如果比较之后两值一样，那么代表是正常的请求，如果没取到或者比较不一样，代表不是正常的请求，不执行下一步操作</li></ol> <p><img src="/assets/img/CSRF2.7dcef482.jpg" alt="CSRF攻击和防护的实现"></p> <h4 id="csrf-token的设置过程">CSRF_TOKEN的设置过程</h4> <p><img src="/assets/img/CSRF-TOKEN.08a28da4.png" alt="CSRF"></p> <h2 id="八、数据库">八、数据库</h2> <h3 id="_01-orm框架">01 | ORM框架</h3> <p>O是object，也就<strong>类对象</strong>的意思，R是relation，翻译成中文是关系，也就是关系数据库中<strong>数据表</strong>的意思，M是mapping，是<strong>映射</strong>的意思。在ORM框架中，它帮我们把类和数据表进行了一个映射，可以让我们<strong>通过类和类对象就能操作它所对应的表格中的数据</strong>。ORM框架还有一个功能，它可以<strong>根据我们设计的类自动帮我们生成数据库中的表格</strong>，省去了我们自己建表的过程。</p> <p>django中内嵌了ORM框架，不需要直接面向数据库编程，而是定义模型类，通过模型类和对象完成数据表的增删改查操作。</p> <p>使用django进行数据库开发的步骤如下：</p> <ol><li>配置数据库连接信息</li> <li>在models.py中定义模型类</li> <li>迁移</li> <li>通过类和对象完成数据增删改查操作</li></ol> <p><strong>ORM作用</strong></p> <p><img src="/assets/img/orm.49b7e741.png" alt="orm"></p> <p><img src="/assets/img/orm2.c189dc6c.png" alt="orm"></p> <h3 id="_02-配置">02 | 配置</h3> <p>在settings.py中保存了数据库的连接配置信息，Django默认初始配置使用<strong>sqlite</strong>数据库。</p> <ol><li><p>使用<strong>MySQL</strong>数据库首先需要安装驱动程序</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>pip install PyMySQL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>在Django的工程同名子目录的__init__.py文件中添加如下语句</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pymysql <span class="token keyword">import</span> install_as_MySQLdb

install_as_MySQLdb<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>作用是让Django的ORM能以mysqldb的方式来调用PyMySQL。</p></li> <li><p>修改<strong>DATABASES</strong>配置信息</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.mysql'</span><span class="token punctuation">,</span>
        <span class="token string">'HOST'</span><span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库主机</span>
        <span class="token string">'PORT'</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库端口</span>
        <span class="token string">'USER'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
        <span class="token string">'PASSWORD'</span><span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户密码</span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'django_demo'</span>  <span class="token comment"># 数据库名字</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>在MySQL中创建数据库</p> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>create database django_demo default charset=utf8;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h3 id="_03-定义模型类">03 | 定义模型类</h3> <ul><li>模型类被定义在&quot;应用/models.py&quot;文件中。</li> <li>模型类必须继承自Model类，位于包django.db.models中。</li></ul> <p>接下来首先以&quot;图书-英雄&quot;管理为例进行演示。</p> <h4 id="定义">定义</h4> <p>创建应用booktest，在models.py 文件中定义模型类。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token comment">#定义图书模型类BookInfo</span>
<span class="token keyword">class</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    btitle <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'名称'</span><span class="token punctuation">)</span>
    bpub_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'发布日期'</span><span class="token punctuation">)</span>
    bread <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'阅读量'</span><span class="token punctuation">)</span>
    bcomment <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'评论量'</span><span class="token punctuation">)</span>
    is_delete <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'逻辑删除'</span><span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        db_table <span class="token operator">=</span> <span class="token string">'tb_books'</span>  <span class="token comment"># 指明数据库表名</span>
        verbose_name <span class="token operator">=</span> <span class="token string">'图书'</span>  <span class="token comment"># 在admin站点中显示的名称</span>
        verbose_name_plural <span class="token operator">=</span> verbose_name  <span class="token comment"># 显示的复数名称</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;定义每个数据对象的显示信息&quot;&quot;&quot;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>btitle

<span class="token comment">#定义英雄模型类HeroInfo</span>
<span class="token keyword">class</span> <span class="token class-name">HeroInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    GENDER_CHOICES <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'male'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    hname <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'名称'</span><span class="token punctuation">)</span> 
    hgender <span class="token operator">=</span> models<span class="token punctuation">.</span>SmallIntegerField<span class="token punctuation">(</span>choices<span class="token operator">=</span>GENDER_CHOICES<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'性别'</span><span class="token punctuation">)</span>  
    hcomment <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'描述信息'</span><span class="token punctuation">)</span> 
    hbook <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>BookInfo<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'图书'</span><span class="token punctuation">)</span>  <span class="token comment"># 外键</span>
    is_delete <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'逻辑删除'</span><span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        db_table <span class="token operator">=</span> <span class="token string">'tb_heros'</span>
        verbose_name <span class="token operator">=</span> <span class="token string">'英雄'</span>
        verbose_name_plural <span class="token operator">=</span> verbose_name

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>hname
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>1） 数据库表名</strong></p> <p>模型类如果未指明表名，Django默认以 <strong>小写app应用名_小写模型类名</strong> 为数据库表名。</p> <p>可通过<strong>db_table</strong> 指明数据库表名。</p> <p><strong>2） 关于主键</strong></p> <p><mark>Django会为表创建自动增长的主键列</mark>，每个模型只能有一个主键列，如果使用选项设置某属性为主键列后Django不会再创建自动增长的主键列。</p> <p>默认创建的主键列属性为id，可以使用pk代替，pk全拼为primary key。</p> <p><strong>3） 属性命名限制</strong></p> <ul><li><p>不能是python的保留关键字。</p></li> <li><p>不允许使用连续的下划线，这是由django的查询方式决定的。</p></li> <li><p>定义属性时需要指定字段类型，通过字段类型的参数指定选项，语法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>属性<span class="token operator">=</span>models<span class="token punctuation">.</span>字段类型<span class="token punctuation">(</span>选项<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <p><strong>4）字段类型</strong></p> <table><thead><tr><th style="text-align:left;">类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">AutoField</td> <td style="text-align:left;">自动增长的IntegerField，通常不用指定，不指定时Django会自动创建属性名为id的自动增长属性</td></tr> <tr><td style="text-align:left;">BooleanField</td> <td style="text-align:left;">布尔字段，值为True或False</td></tr> <tr><td style="text-align:left;">NullBooleanField</td> <td style="text-align:left;">支持Null、True、False三种值</td></tr> <tr><td style="text-align:left;">CharField</td> <td style="text-align:left;">字符串，参数max_length表示最大字符个数</td></tr> <tr><td style="text-align:left;">TextField</td> <td style="text-align:left;">大文本字段，一般超过4000个字符时使用</td></tr> <tr><td style="text-align:left;">IntegerField</td> <td style="text-align:left;">整数</td></tr> <tr><td style="text-align:left;">DecimalField</td> <td style="text-align:left;">十进制浮点数， 参数max_digits表示总位数， 参数decimal_places表示小数位数</td></tr> <tr><td style="text-align:left;">FloatField</td> <td style="text-align:left;">浮点数</td></tr> <tr><td style="text-align:left;">DateField</td> <td style="text-align:left;">日期， 参数auto_now表示每次保存对象时，自动设置该字段为当前时间，用于&quot;最后一次修改&quot;的时间戳，它总是使用当前日期，默认为False； 参数auto_now_add表示当对象第一次被创建时自动设置当前时间，用于创建的时间戳，它总是使用当前日期，默认为False; 参数auto_now_add和auto_now是相互排斥的，组合将会发生错误</td></tr> <tr><td style="text-align:left;">TimeField</td> <td style="text-align:left;">时间，参数同DateField</td></tr> <tr><td style="text-align:left;">DateTimeField</td> <td style="text-align:left;">日期时间，参数同DateField</td></tr> <tr><td style="text-align:left;">FileField</td> <td style="text-align:left;">上传文件字段</td></tr> <tr><td style="text-align:left;">ImageField</td> <td style="text-align:left;">继承于FileField，对上传的内容进行校验，确保是有效的图片</td></tr></tbody></table> <p><strong>5） 选项</strong></p> <table><thead><tr><th style="text-align:left;">选项</th> <th>说明</th></tr></thead> <tbody><tr><td style="text-align:left;">null</td> <td>如果为True，表示允许为空，默认值是False</td></tr> <tr><td style="text-align:left;">blank</td> <td>如果为True，则该字段允许为空白，默认值是False</td></tr> <tr><td style="text-align:left;">db_column</td> <td>字段的名称，如果未指定，则使用属性的名称</td></tr> <tr><td style="text-align:left;">db_index</td> <td>若值为True, 则在表中会为此字段创建索引，默认值是False</td></tr> <tr><td style="text-align:left;">default</td> <td>默认</td></tr> <tr><td style="text-align:left;">primary_key</td> <td>若为True，则该字段会成为模型的主键字段，默认值是False，一般作为AutoField的选项使用</td></tr> <tr><td style="text-align:left;">unique</td> <td>如果为True, 这个字段在表中必须有唯一值，默认值是False</td></tr></tbody></table> <p><strong>null是数据库范畴的概念，blank是表单验证范畴的</strong></p> <p><strong>6） 外键</strong></p> <p>在设置外键时，需要通过<strong>on_delete</strong>选项指明主表删除数据时，对于外键引用表数据如何处理，在django.db.models中包含了可选常量：</p> <ul><li><p><strong>CASCADE</strong> 级联，删除主表数据时连通一起删除外键表中数据</p></li> <li><p><strong>PROTECT</strong> 保护，通过抛出<strong>ProtectedError</strong>异常，来阻止删除主表中被外键应用的数据</p></li> <li><p><strong>SET_NULL</strong> 设置为NULL，仅在该字段null=True允许为null时可用</p></li> <li><p><strong>SET_DEFAULT</strong> 设置为默认值，仅在该字段设置了默认值时可用</p></li> <li><p><strong>SET()</strong> 设置为特定值或者调用特定方法，如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> get_user_model
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token keyword">def</span> <span class="token function">get_sentinel_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>
        settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span>
        on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>SET<span class="token punctuation">(</span>get_sentinel_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><strong>DO_NOTHING</strong> 不做任何操作，如果数据库前置指明级联性，此选项会抛出<strong>IntegrityError</strong>异常</p></li></ul> <h4 id="迁移">迁移</h4> <p>将模型类同步到数据库中。</p> <p><strong>1）生成迁移文件</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py makemigrations
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>2）同步到数据库中</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py migrate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="添加测试数据">添加测试数据</h4> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>insert into tb_books(btitle,bpub_date,bread,bcomment,is_delete) values
('射雕英雄传','1980-5-1',12,34,0),
('天龙八部','1986-7-24',36,40,0),
('笑傲江湖','1995-12-24',20,80,0),
('雪山飞狐','1987-11-11',58,24,0);
insert into tb_heros(hname,hgender,hbook_id,hcomment,is_delete) values
('郭靖',1,1,'降龙十八掌',0),
('黄蓉',0,1,'打狗棍法',0),
('黄药师',1,1,'弹指神通',0),
('欧阳锋',1,1,'蛤蟆功',0),
('梅超风',0,1,'九阴白骨爪',0),
('乔峰',1,2,'降龙十八掌',0),
('段誉',1,2,'六脉神剑',0),
('虚竹',1,2,'天山六阳掌',0),
('王语嫣',0,2,'神仙姐姐',0),
('令狐冲',1,3,'独孤九剑',0),
('任盈盈',0,3,'弹琴',0),
('岳不群',1,3,'华山剑法',0),
('东方不败',0,3,'葵花宝典',0),
('胡斐',1,4,'胡家刀法',0),
('苗若兰',0,4,'黄衣',0),
('程灵素',0,4,'医术',0),
('袁紫衣',0,4,'六合拳',0);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_04-演示工具使用">04 | 演示工具使用</h3> <h4 id="shell工具">shell工具</h4> <p>Django的manage工具提供了<strong>shell</strong>命令，帮助我们配置好当前工程的运行环境（如连接好数据库等），以便可以直接在终端中执行测试python语句。</p> <p>通过如下命令进入shell</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py shell
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/django_shell.1cad39b2.png" alt="django shell"></p> <p>导入两个模型类，以便后续使用</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> booktest<span class="token punctuation">.</span>models <span class="token keyword">import</span> BookInfo<span class="token punctuation">,</span> HeroInfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id=""></h4> <h4 id="查看mysql数据库日志">查看MySQL数据库日志</h4> <p>查看mysql数据库日志可以查看对数据库的操作记录。 mysql日志文件默认没有产生，需要做如下配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">vi</span> /etc/mysql/mysql.conf.d/mysqld.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/mysql_log.ea45e01f.png" alt="mysql 日志"></p> <p>把68，69行前面的#去除，然后保存并使用如下命令重启mysql服务。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">service</span> mysql restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用如下命令打开mysql日志文件。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tail</span> -f /var/log/mysql/mysql.log  <span class="token comment"># 可以实时查看数据库的日志内容</span>
<span class="token comment"># 如提示需要sudo权限，执行</span>
<span class="token comment"># sudo tail -f /var/log/mysql/mysql.log</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_05-数据库操作-增">05 | 数据库操作—增</h3> <p>增加数据有两种方法。</p> <h4 id="save">save</h4> <p>通过创建模型类对象，执行对象的save()方法保存到数据库中。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> datetime <span class="token keyword">import</span> date
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> book <span class="token operator">=</span> BookInfo<span class="token punctuation">(</span>
    btitle<span class="token operator">=</span><span class="token string">'西游记'</span><span class="token punctuation">,</span>
    bpub_date<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">1988</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    bread<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
    bcomment<span class="token operator">=</span><span class="token number">10</span>
<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> book<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> hero <span class="token operator">=</span> HeroInfo<span class="token punctuation">(</span>
    hname<span class="token operator">=</span><span class="token string">'孙悟空'</span><span class="token punctuation">,</span>
    hgender<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    hbook<span class="token operator">=</span>book
<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> hero<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> hero2 <span class="token operator">=</span> HeroInfo<span class="token punctuation">(</span>
    hname<span class="token operator">=</span><span class="token string">'猪八戒'</span><span class="token punctuation">,</span>
    hgender<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    hbook_id<span class="token operator">=</span>book<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> hero2<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="create">create</h4> <p>通过模型类.objects.create()保存。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
    hname<span class="token operator">=</span><span class="token string">'沙悟净'</span><span class="token punctuation">,</span>
    hgender<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    hbook<span class="token operator">=</span>book
<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>HeroInfo<span class="token punctuation">:</span> 沙悟净<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_06-数据库操作-删">06 | 数据库操作—删</h3> <p>删除有两种方法</p> <h4 id="模型类对象delete">模型类对象delete</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code>hero <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>
hero<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="模型类-objects-filter-delete">模型类.objects.filter().delete()</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_07-数据库操作-改">07 | 数据库操作—改</h3> <p>修改更新有两种方法</p> <h4 id="save-2">save</h4> <p><strong>修改模型类对象的属性，然后执行save()方法</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>hero <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>hname<span class="token operator">=</span><span class="token string">'猪八戒'</span><span class="token punctuation">)</span>
hero<span class="token punctuation">.</span>hname <span class="token operator">=</span> <span class="token string">'猪悟能'</span>
hero<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="update">update</h4> <p><strong>使用模型类.objects.filter().update()</strong>，会返回受影响的行数</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hname<span class="token operator">=</span><span class="token string">'沙悟净'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>hname<span class="token operator">=</span><span class="token string">'沙僧'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_08-数据库操作-查">08 | 数据库操作—查</h3> <h4 id="基本查询">基本查询</h4> <p><strong>get</strong> 查询单一结果，如果不存在会抛出<strong>模型类.DoesNotExist</strong>异常</p> <p><strong>all</strong> 查询多个结果</p> <p><strong>count</strong> 查询结果数量</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 射雕英雄传<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 天龙八部<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 笑傲江湖<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 雪山飞狐<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 西游记<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> book <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>btitle<span class="token operator">=</span><span class="token string">'西游记'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> book<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">5</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 笑傲江湖<span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 笑傲江湖<span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">&quot;&lt;console&gt;&quot;</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
  File <span class="token string">&quot;/Users/delron/.virtualenv/dj/lib/python3.6/site-packages/django/db/models/manager.py&quot;</span><span class="token punctuation">,</span> line <span class="token number">85</span><span class="token punctuation">,</span> <span class="token keyword">in</span> manager_method
    <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_queryset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
  File <span class="token string">&quot;/Users/delron/.virtualenv/dj/lib/python3.6/site-packages/django/db/models/query.py&quot;</span><span class="token punctuation">,</span> line <span class="token number">380</span><span class="token punctuation">,</span> <span class="token keyword">in</span> get
    self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>_meta<span class="token punctuation">.</span>object_name
db<span class="token punctuation">.</span>models<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span> BookInfo matching query does <span class="token keyword">not</span> exist<span class="token punctuation">.</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token number">6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="过滤查询">过滤查询</h4> <p>实现SQL中的where功能，包括</p> <ul><li><strong>filter</strong> 过滤出多个结果</li> <li><strong>exclude</strong> 排除掉符合条件剩下的结果</li> <li><strong>get</strong> 过滤单一结果</li></ul> <p>对于过滤条件的使用，上述三个方法相同，故仅以<strong>filter</strong>进行讲解。</p> <p>过滤条件的表达语法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>属性名称__比较运算符<span class="token operator">=</span>值
<span class="token comment"># 属性名称和比较运算符间使用两个下划线，所以属性名不能包括多个下划线</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>1）相等</strong></p> <p><strong>exact：表示判等</strong></p> <p>例：查询编号为1的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__exact<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
可简写为：
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>2）模糊查询</strong></p> <p><strong>contains：是否包含</strong> <strong>说明：</strong> <mark>如果要包含%无需转义，直接写即可</mark></p> <p>例：查询书名包含'传'的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>btitle__contains<span class="token operator">=</span><span class="token string">'传'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>startswith、endswith：以指定值开头或结尾</strong></p> <p>例：查询书名以'部'结尾的图书</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>btitle__endswith<span class="token operator">=</span><span class="token string">'部'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Tips</p> <p>以上运算符都区分大小写，在这些运算符前加上i表示不区分大小写，如iexact、icontains、istartswith、iendswith</p></div> <p><strong>3）空查询</strong></p> <p><strong>isnull：是否为null</strong></p> <p>例：查询书名不为空的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>btitle__isnull<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>4）范围查询</strong></p> <p><strong>in：是否包含在范围内</strong></p> <p>例：查询编号为1或3或5的图书</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__in<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>5）比较查询</strong></p> <p><strong>gt</strong> 大于 (greater then)</p> <p><strong>gte</strong> 大于等于 (greater then equal)</p> <p><strong>lt</strong> 小于 (less then)</p> <p><strong>lte</strong> 小于等于 (less then equal)</p> <p>例：查询编号大于3的图书</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__gt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>6）不等于的运算符，使用exclude()过滤器。</strong></p> <p>例：查询编号不等于3的图书</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>7）日期查询</strong></p> <p><strong>year、month、day、week_day、hour、minute、second：对日期时间类型的属性进行运算。</strong></p> <p>例：查询1980年发表的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bpub_date__year<span class="token operator">=</span><span class="token number">1980</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>例：查询1980年1月1日后发表的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bpub_date__gt<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">1990</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="f对象">F对象</h4> <p>之前的查询都是对象的属性与常量值比较，两个属性怎么比较呢？ 答：使用F对象，被定义在django.db.models中。</p> <p>语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>F(属性名)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>例：查询阅读量大于等于评论量的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> F

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gte<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'bcomment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以在F对象上使用算数运算。</p> <p>例：查询阅读量大于2倍评论量的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'bcomment'</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="q对象">Q对象</h4> <p><strong>多个过滤器逐个调用表示逻辑与关系，同sql语句中where部分的and关键字。</strong></p> <p>例：查询阅读量大于20，并且编号小于3的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>id__lt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
或
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__lt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>如果需要实现逻辑或or的查询，需要使用Q()对象结合|运算符</strong>，Q对象被义在django.db.models中。</p> <p>语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Q(属性名__运算符=值)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>例：查询阅读量大于20的图书，改写为Q对象如下。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Q对象可以使用&amp;、|连接，&amp;表示逻辑与，|表示逻辑或。</p> <p>例：查询阅读量大于20，或编号小于3的图书，只能使用Q对象实现</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>pk__lt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Q对象前可以使用~操作符，表示非not。</p> <p>例：查询编号不等于3的图书。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token operator">~</span>Q<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="聚合函数">聚合函数</h4> <p>使用aggregate()过滤器调用聚合函数。聚合函数包括：<strong>Avg</strong> 平均，<strong>Count</strong> 数量，<strong>Max</strong> 最大，<strong>Min</strong> 最小，<strong>Sum</strong> 求和，被定义在django.db.models中。</p> <p>例：查询图书的总阅读量。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sum

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>Sum<span class="token punctuation">(</span><span class="token string">'bread'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意aggregate的返回值是一个字典类型，格式如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>  <span class="token punctuation">{</span><span class="token string">'属性名__聚合类小写'</span><span class="token punctuation">:</span>值<span class="token punctuation">}</span>
  如<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">'bread__sum'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用count时一般不使用aggregate()过滤器。</p> <p>例：查询图书总数。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意count函数的返回值是一个数字。</p> <h4 id="排序">排序</h4> <p>使用<strong>order_by</strong>对结果进行排序</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'bread'</span><span class="token punctuation">)</span>  <span class="token comment"># 升序</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-bread'</span><span class="token punctuation">)</span>  <span class="token comment"># 降序</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="关联查询">关联查询</h4> <p>由一到多的访问语法：</p> <p>一对应的模型类对象.多对应的模型类名小写_set 例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>b <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>heroinfo_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>由多到一的访问语法:</p> <p>多对应的模型类对象.多对应的模型类中的关系类属性名 例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>h <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span>hbook
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>访问一对多的模型类关联对象的id语法:</p> <p>多对一的模型类对象.关联类属性_id</p> <p>例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>h <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span>hbook_id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="关联过滤查询">关联过滤查询</h4> <p><strong>由多模型类条件查询一模型类数据</strong>:</p> <p>语法如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>关联模型类名小写__属性名__条件运算符<span class="token operator">=</span>值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>注意：如果没有&quot;__运算符&quot;部分，表示等于。</strong></p> <p>例：</p> <p>查询图书，要求图书英雄为&quot;孙悟空&quot;</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>heroinfo__hname<span class="token operator">=</span><span class="token string">'孙悟空'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查询图书，要求图书中英雄的描述包含&quot;八&quot;</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>heroinfo__hcomment__contains<span class="token operator">=</span><span class="token string">'八'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>由一模型类条件查询多模型类数据</strong>:</p> <p>语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>一模型类关联属性名__一模型类属性名__条件运算符=值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>注意：如果没有&quot;__运算符&quot;部分，表示等于。</strong></p> <p>例：</p> <p>查询书名为“天龙八部”的所有英雄。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hbook__btitle<span class="token operator">=</span><span class="token string">'天龙八部'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查询图书阅读量大于30的所有英雄</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hbook__bread__gt<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="查询集-queryset">查询集 QuerySet</h4> <p><strong>1）概念</strong></p> <p>Django的ORM中存在查询集的概念。</p> <p>查询集，也称查询结果集、QuerySet，表示从数据库中获取的对象集合。</p> <p>当调用如下过滤器方法时，Django会返回查询集（而不是简单的列表）：</p> <ul><li>all()：返回所有数据。</li> <li>filter()：返回满足条件的数据。</li> <li>exclude()：返回满足条件之外的数据。</li> <li>order_by()：对结果进行排序。</li></ul> <p>对查询集可以再次调用过滤器进行过滤，如</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'bpub_date'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就意味着查询集可以含有零个、一个或多个过滤器。过滤器基于所给的参数限制查询的结果。</p> <p><strong>从SQL的角度讲，查询集与select语句等价，过滤器像where、limit、order by子句。</strong></p> <div class="custom-block tip"><p class="custom-block-title">Tips</p> <p><strong>判断某一个查询集中是否有数据</strong>：</p> <ul><li>exists()：判断查询集中是否有数据，如果有则返回True，没有则返回False。</li></ul></div> <p><strong>2）两大特性</strong></p> <p><font color="red">惰性执行</font></p> <p>创建查询集不会访问数据库，直到调用数据时，才会访问数据库，调用数据的情况包括迭代、序列化、与if合用</p> <p>例如，当执行如下语句时，并未进行数据库查询，只是创建了一个查询集qs</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>qs <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>继续执行遍历迭代操作后，才真正的进行了数据库的查询</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> book <span class="token keyword">in</span> qs<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>btitle<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><font color="red">缓存</font></p> <p>使用同一个查询集，第一次使用时会发生数据库的查询，然后Django会把结果缓存下来，再次使用这个查询集时会使用缓存的数据，减少了数据库的查询次数。</p> <p><strong>情况一</strong>：如下是两个查询集，无法重用缓存，每次查询都会与数据库进行一次交互，增加了数据库的负载。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> booktest<span class="token punctuation">.</span>models <span class="token keyword">import</span> BookInfo
<span class="token punctuation">[</span>book<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> book <span class="token keyword">in</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>book<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> book <span class="token keyword">in</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/assets/img/queryset_uncache.072b84ea.png" alt="两个查询集"></p> <p><img src="/assets/img/queyrset_uncache_result.94d9e193.png" alt="两次查询"></p> <p><strong>情况二</strong>：经过存储后，可以重用查询集，第二次使用缓存中的数据。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>qs<span class="token operator">=</span>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>book<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> book <span class="token keyword">in</span> qs<span class="token punctuation">]</span>
<span class="token punctuation">[</span>book<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> book <span class="token keyword">in</span> qs<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/assets/img/queryset_cache.499f8644.png" alt="一个查询集"></p> <p><img src="/assets/img/queryset_cache_result.85ead83d.png" alt="一次查询"></p> <p><strong>3）限制查询集</strong></p> <p>可以对查询集进行取下标或切片操作，等同于sql中的limit和offset子句。</p> <blockquote><p>注意：不支持负数索引。</p></blockquote> <p><strong>对查询集进行切片后返回一个新的查询集，不会立即执行查询。</strong></p> <p>如果获取一个对象，直接使用[0]，等同于[0:1].get()，但是如果没有数据，[0]引发IndexError异常，[0:1].get()如果没有数据引发DoesNotExist异常。</p> <p>示例：获取第1、2项，运行查看。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>qs <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="管理器manager">管理器Manager</h4> <p>管理器是Django的模型进行数据库操作的接口，Django应用的每个模型类都拥有至少一个管理器。</p> <p>我们在通过模型类的<strong>objects</strong>属性提供的方法操作数据库时，即是在使用一个管理器对象objects。当没有为模型类定义管理器时，Django会为每一个模型类生成一个名为objects的管理器，它是<strong>models.Manager</strong>类的对象。</p> <p>我们可以自定义管理器，并应用到我们的模型类上。</p> <p><strong>注意：一旦为模型类指明自定义的过滤器后，Django不再生成默认管理对象objects。</strong></p> <p>自定义管理器类主要用于两种情况：</p> <p><strong>1. 修改原始查询集，重写all()方法。</strong></p> <p>a）打开booktest/models.py文件，定义类BookInfoManager</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#图书管理器</span>
<span class="token keyword">class</span> <span class="token class-name">BookInfoManager</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#默认查询未删除的图书信息</span>
        <span class="token comment">#调用父类的成员语法为：super().方法名</span>
        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_delete<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>b）在模型类BookInfo中定义管理器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>class BookInfo(models.Model):
    ...
    books = BookInfoManager()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>c）使用方法</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>2. 在管理器类中补充定义新的方法</strong></p> <p>a）打开booktest/models.py文件，定义方法create。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BookInfoManager</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#创建模型类，接收参数为属性赋值</span>
    <span class="token keyword">def</span> <span class="token function">create_book</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> title<span class="token punctuation">,</span> pub_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#创建模型类对象self.model可以获得模型类</span>
        book <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token punctuation">)</span>
        book<span class="token punctuation">.</span>btitle <span class="token operator">=</span> title
        book<span class="token punctuation">.</span>bpub_date <span class="token operator">=</span> pub_date
        book<span class="token punctuation">.</span>bread<span class="token operator">=</span><span class="token number">0</span>
        book<span class="token punctuation">.</span>bcommet<span class="token operator">=</span><span class="token number">0</span>
        book<span class="token punctuation">.</span>is_delete <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># 将数据插入进数据表</span>
        book<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> book
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>b）为模型类BookInfo定义管理器books语法如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>class BookInfo(models.Model):
      ...
    books = BookInfoManager()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>c）调用语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>book=BookInfo.books.create_book(&quot;abc&quot;,date(1980,1,1))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/small-universe/vuepress-python/edit/master/docs/nav.10.后端/02.Django/01.Django基础.md" target="_blank" rel="noopener noreferrer">改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/23/2021, 1:22:01 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/hou-duan/python/designpatterns.html" class="prev">
        设计模式
      </a></span> <span class="next"><a href="/hou-duan/django/drf.html">
        Django  REST  framework
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><div class="container" data-v-081c2a30><button type="button" class="el-button button el-button--default is-plain" data-v-081c2a30><!----><i class="el-icon-s-operation"></i><span>目录</span></button> <!----></div></div></div>
    <script src="/assets/js/app.3924b14b.js" defer></script><script src="/assets/js/3.8a978e8e.js" defer></script><script src="/assets/js/4.d4a9f15a.js" defer></script><script src="/assets/js/11.e4da742c.js" defer></script><script src="/assets/js/10.af37d65e.js" defer></script>
  </body>
</html>
